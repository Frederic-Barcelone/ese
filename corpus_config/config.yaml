# ==============================================================================
# RARE DISEASE EXTRACTION - TWO-STAGE PIPELINE CONFIGURATION v12.3
# ==============================================================================
# Both extraction stages run sequentially for each document
# corpus_config/config.yaml
#
# CHANGES IN v12.3:
# - Added deduplication configuration for cross-type entity cleanup
# - Added promotion configuration for ID-gated abbreviation promotion
# - Enhanced validation settings with fuzzy matching options
# - Added disease name completion settings
#Â  corpus_config/config.yaml


system:
  name: "Rare Disease Document Extraction"
  version: "12.3-pipeline"
  description: "Two-stage extraction pipeline: metadata then entities with enhanced deduplication"

# Global feature control
features:
  # Core extraction features
  drug_detection: true
  disease_detection: true
  classification: true
  abbreviation_expansion: true
  abbreviations: true
  table_extraction: true
  section_detection: true
  intelligent_rename: true 
  
  # Metadata extraction features
  description: true # lang and short
  dates: true
  title: true # better file name

  # NEW: Citation, Person, and Reference extraction (ADD THESE 3 LINES)
  citation_extraction: true      
  person_extraction: true        
  reference_extraction: true     
  
  # External API features
  pubtator_enrichment: true   # Use PubTator3 API for entity enrichment
  ai_validation: true         # Use Claude AI for validation of extracted entities
  ai_analysis: true           # Use Claude AI for deeper document analysis
  
  # Lexicon features
  use_drug_lexicon: true
  use_disease_lexicon: true
  use_medical_terms_filter: true
  filename_suggestions: true
  investigational_drugs_matching: true
  use_clinical_trial_lexicon: true  # Alexion clinical trials
  
  # Caching
  enable_caching: true
  enable_document_caching: true

# Model configurations - Only SpaCy models here
models:
  # SpaCy models for NLP processing
  spacy:
    - name: en_core_sci_lg
      purpose: scientific_large
    - name: en_ner_bc5cdr_md
      purpose: drugs_diseases

# Pipeline configuration
pipeline:
  stages:
    - name: metadata
      sequence: 1
      description: "Extract document metadata for classification and organization"
      limits:
        pdf_pages: 10      # Quick scan of first pages
        text_chars: 50000  # Limited text processing
        excel_rows: 1000   # Limited rows
      tasks:
        - classification
        - description
        - dates
        - title
        - filename_proposal
    
    - name: entities
      sequence: 2
      description: "Extract medical entities and detailed content"
      limits:
        pdf_pages: null    # Process entire document
        text_chars: null   # No text limit
        excel_rows: null   # No row limit
      tasks:
        - drug_detection
        - disease_detection
        - abbreviation_extraction 
        - citation_extraction      
        - person_extraction        
        - reference_extraction     
        
# API Configuration - Single source for all API settings
api_configuration:
  pubtator3:
    enabled: "${features.pubtator_enrichment}"
    base_url: "https://www.ncbi.nlm.nih.gov/research/pubtator3-api"
    cache:
      enabled: true
      directory: "./cache/pubtator"
    rate_limit:
      requests_per_minute: 30
    timeout_seconds: 30
  
  claude:
    enabled: "${features.ai_validation}"
    model: "claude-3-5-sonnet-20241022"
    max_tokens: 1500
    temperature: 0
    # API key should be set via environment variable CLAUDE_API_KEY
    # or can be set directly here (not recommended for security):
    # api_key: "sk-ant-..."

# ==============================================================================
# DEDUPLICATION CONFIGURATION (NEW IN v12.3)
# ==============================================================================
# Controls how entities are deduplicated across different entity types
# Prevents issues like "PJP" appearing in both abbreviations and diseases

deduplication:
  # Enable cross-type entity deduplication
  # Recommended: true (prevents abbreviations from being extracted as diseases)
  across_entity_types: true
  
  # Priority order for deduplication (most specific entity type wins)
  # When same term appears in multiple types, keep the one highest in this list
  priority_order: ['drug', 'disease', 'abbreviation']
  
  # Enable detailed logging of deduplication decisions
  # Set to true for debugging, false for production
  verbose_logging: false
  
  # Remove abbreviations whose expansions match disease entities
  # Example: If "PJP" expands to "Pneumocystis jirovecii pneumonia" and
  # that disease is detected, remove "PJP" from abbreviations
  remove_expansion_matches: true

# ==============================================================================
# PROMOTION CONFIGURATION (NEW IN v12.3)
# ==============================================================================
# Controls ID-gated promotion of abbreviations to drugs/diseases

promotion:
  # Minimum number of identifiers required for promotion
  # 1 = lenient (any single ID promotes)
  # 2 = moderate (need 2+ IDs)
  # 3 = strict (need 3+ IDs)
  min_ids_required: 1
  
  # Allow promotion even if not all preferred IDs are present
  # true = promote with partial ID coverage
  # false = require complete ID set
  allow_partial_ids: true
  
  # Preferred identifier types (in priority order)
  # Promotion will check for these IDs first
  preferred_drug_ids:
    - RxCUI      # RxNorm Concept Unique Identifier (primary)
    - MESH       # Medical Subject Headings
    - ATC        # Anatomical Therapeutic Chemical Classification
    - DrugBank   # DrugBank identifier
    - UNII       # Unique Ingredient Identifier
  
  preferred_disease_ids:
    - ORPHA      # Orphanet identifier (primary for rare diseases)
    - DOID       # Disease Ontology identifier
    - SNOMED_CT  # SNOMED Clinical Terms
    - ICD10      # ICD-10 code
    - UMLS_CUI   # UMLS Concept Unique Identifier
  
  # Confidence boost for promoted entities
  # Entities promoted from abbreviations get this confidence boost
  promotion_confidence_boost: 0.05
  
  # Enable detailed promotion logging
  log_promotion_details: true

# ==============================================================================
# VALIDATION CONFIGURATION (ENHANCED IN v12.3)
# ==============================================================================
# Entity-specific validation settings

validation:
  drug:
    use_claude: "${features.ai_validation}"
    confidence_threshold: 0.85
    stages:
      - false_positive_filter
      - knowledge_base
      - claude_ai
    
    # Fuzzy matching for drug name normalization
    fuzzy_matching:
      enabled: true
      threshold: 85  # 0-100, higher = stricter matching
      algorithms:
        - token_sort_ratio
        - partial_ratio
  
  disease:
    use_claude: "${features.ai_validation}"
    confidence_threshold: 0.75
    enrichment_mode: "balanced"  # Options: strict, balanced, permissive
    stages:
      - pattern_detection
      - lexicon_matching
      - claude_ai
    
    # Fuzzy matching for disease name normalization (NEW)
    fuzzy_matching:
      enabled: true
      threshold: 85  # Minimum similarity score (0-100)
      max_attempts: 3  # Try up to N fuzzy matches per entity
      fallback_to_parent: true  # Try parent terms if exact match fails
    
    # Disease name completion settings (NEW)
    name_completion:
      enabled: true
      use_context_window: 50  # Characters before/after for context
      use_abbreviation_map: true  # Use abbreviation expansions
      
      # Common incomplete patterns to detect
      incomplete_patterns:
        - "-Associated$"
        - "-Onset$"
        - "-Related$"
        - "-Induced$"
        - "-Mediated$"
      
      # Attempt completion with these suffixes
      common_completions:
        - "Vasculitis"
        - "Syndrome"
        - "Disease"
        - "Disorder"
        - "Neuropathy"
    
    # Symptom/finding filtering (NEW)
    symptom_filtering:
      enabled: true
      exclude_symptoms: true  # Filter out symptoms like "pain", "fever"
      exclude_findings: true  # Filter out findings like "hemorrhage"
      
      # Always keep these terms even if they match filters
      whitelist:
        - "pneumocystis jirovecii pneumonia"
        - "diffuse alveolar hemorrhage"
        - "peripheral neuropathy"
        - "diabetic neuropathy"
        - "end-stage renal disease"
        - "chronic kidney disease"
        - "acute kidney injury"
        - "glomerulonephritis"
    
    # Generic term filtering
    generic_filtering:
      enabled: true
      require_ids_for_generic: true  # Generic terms need IDs to be kept
      
      # Terms considered too generic without IDs
      generic_terms:
        - "neuropathy"
        - "myopathy"
        - "arthropathy"
        - "infection"
        - "inflammation"
        - "disorder"
        - "condition"

# Resource paths - Lexicons and databases
resources:
  abbreviation_general: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_abbreviation_general.json"
  
  abbreviation_umls_biological: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_umls_biological_abbreviations_v5.tsv"
  
  abbreviation_umls_clinical: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_umls_clinical_abbreviations_v5.tsv"
  
  clinical_trial_metadata: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/00966_clinical_trial_metadata.json"
  
  disease_lexicon: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_lexicon_disease.json"
  
  disease_ontology_db: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_db/disease_ontology.db"
  
  disease_orphanet_db: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_db/orphanet_nlp.db"
  
  disease_rare_acronyms: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_rare_disease_acronyms.json"
  
  document_types: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_document_types.json"
  
  drug_alexion: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_alexion_drugs.json"
  
  drug_fda_approved: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_fda_approved_drugs.json"
  
  drug_investigational: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_investigational_drugs.json"
  
  drug_lexicon: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_lexicon_drug.json"
   
  medical_terms_lexicon: "/Users/kxbb828/Library/CloudStorage/OneDrive-AZCollaboration/Desktop/WIP-ESE/17_Corpus/corpus_dictionaries/output_datasources/2025_08_lexicon_medical_terms.json"

# Detection thresholds
thresholds:
  confidence: 0.75
  fuzzy_match: 85
  context_window: 150
  min_term_length:
    drug: 3
    disease: 4

# Output configuration
output:
  format: "json"
  json_indent: 2
  include:
    statistics: true
    confidence: true
    positions: false
    context: true
    identifiers: ["mesh", "rxcui", "orphanet", "doid", "study_code"]
  
  # Validation output settings (NEW)
  validation:
    include_warnings: true
    include_recommendations: true
    include_quality_metrics: true
    include_deduplication_stats: true

# Runtime configuration
runtime:
  batch_size: 10
  parallel_workers: 1
  timeout_seconds: 300
  max_file_size_mb: 100

# Logging
logging:
  level: "INFO"  
  console_level: "ERROR"
  console: false
  file: "corpus_logs/corpus.log"
  
  # Component-specific logging levels (NEW)
  components:
    deduplication: "INFO"  # Set to DEBUG for detailed deduplication logs
    promotion: "INFO"      # Set to DEBUG for detailed promotion logs
    enrichment: "INFO"     # Set to DEBUG for detailed enrichment logs
    validation: "INFO"     # Set to DEBUG for detailed validation logs

# Error handling
error_handling:
  max_retries: 3
  on_error: "log_and_continue"
  
  # Recovery settings (NEW)
  partial_results_on_error: true  # Return partial results if stage fails
  continue_on_deduplication_error: true  # Continue even if dedup fails
  continue_on_enrichment_error: true     # Continue even if enrichment fails

# ==============================================================================
# QUALITY CONTROL (NEW IN v12.3)
# ==============================================================================
# Settings for automated quality checks and validation

quality_control:
  # Enable automated quality assessment
  enabled: true
  
  # Minimum acceptable quality scores (0.0-1.0)
  thresholds:
    overall_assessment: 0.6  # Overall quality score
    disease_id_coverage: 0.3  # Minimum % of diseases with IDs
    drug_id_coverage: 0.5     # Minimum % of drugs with IDs
    promotion_rate: 0.0       # Minimum promotion rate (0 = no minimum)
  
  # Generate quality report
  generate_report: true
  report_format: "txt"  # Options: txt, json, both
  
  # Fail extraction if quality below threshold
  fail_on_low_quality: false
  
  # Quality warnings to monitor
  monitor_warnings:
    - "symptom_contamination"
    - "incomplete_names"
    - "abbreviations_as_diseases"
    - "generic_terms_without_ids"
    - "low_id_coverage"
    - "low_promotion_rate"

# ==============================================================================
# CITATION EXTRACTOR CONFIGURATION (NEW IN v12.3)
# ==============================================================================
citation:
  # Minimum confidence threshold for extracted citations
  min_confidence: 0.5
  
  # Extract context around citations
  extract_context: true
  context_window: 100  # Characters before/after citation
  
  # Detect and classify citation styles (Vancouver, APA, Harvard, etc.)
  detect_style: true
  
  # Link inline citations to reference list
  link_inline_citations: true
  
  # Extract DOIs, PMIDs, PMC IDs, and other identifiers from citations
  extract_identifiers: true
  
  # Deduplicate citations by DOI/PMID
  deduplicate_by_identifier: true

# ==============================================================================
# PERSON EXTRACTOR CONFIGURATION (NEW IN v12.3)
# ==============================================================================
person:
  # Minimum confidence threshold for extracted persons
  min_confidence: 0.5
  
  # Extract context around person mentions
  extract_context: true
  context_window: 100  # Characters before/after person mention
  
  # Extract institutional affiliations
  extract_affiliations: true
  
  # Validate ORCID checksums (if ORCID detected)
  validate_orcid_checksums: true
  
  # Classify person roles (author, PI, investigator, etc.)
  classify_roles: true
  
  # Build co-author network graph
  build_coauthor_network: true
  
  # Deduplicate persons by name normalization
  deduplicate_persons: true

# ==============================================================================
# REFERENCE EXTRACTOR CONFIGURATION (NEW IN v12.3)
# ==============================================================================
reference:
  # Minimum confidence threshold for extracted references
  min_confidence: 0.5
  
  # Extract context around reference mentions
  extract_context: true
  context_window: 100  # Characters before/after reference
  
  # Classify reference roles (cited, supporting, conflicting, etc.)
  classify_roles: true
  
  # Reconstruct full URLs from partial references
  reconstruct_urls: true
  
  # Validate checksums for identifiers (DOI, PMID checksums)
  validate_checksums: true
  
  # Extract all 60+ reference types (DOI, PMID, NCT, EMA, etc.)
  extract_all_types: true
  
  # Group related references (e.g., same trial, same publication)
  group_related_references: true


# ==============================================================================
# EXPERIMENTAL FEATURES (NEW IN v12.3)
# ==============================================================================
# Features still under development or testing

experimental:
  # Use machine learning models for entity disambiguation
  ml_disambiguation: false
  
  # Use context embeddings for better entity matching
  context_embeddings: false
  
  # Automatic ontology alignment
  auto_ontology_alignment: false
  
  # Multi-language support (currently English only)
  multi_language: false